---
created: 2021-12-16
updated: 2021-12-16
---
# 深度缓冲

深度缓冲是由窗口系统自动创建的，它会以 16、24、32 位 float 的形式存储它的深度值。大部分系统中，深度缓冲的进度都是 24 位的。深度缓冲的大小与颜色缓冲一致，即有相同的宽度和高度。

当深度测试打开后，OpenGL 在渲染每个片元时，会将这个这个片元的深度值与当前深度缓冲中的深度值进行比较测试，如果测试通过，则这个片元会被渲染，且深度缓冲内的值会被这个新的深度值覆盖，失败的话，则直接丢弃这个片元。

计算遮挡关系的过程被称为 `Occlusion` 。

```ad-note
理论上默认深度缓冲的监测是在片段着色器和模版测试后。 但现在大部分GPU都有提前深度测试的硬件特性，即先进行深度测试，再运行片段着色器，这样如果一个片段不可见，那么就能直接丢弃这个片段，避免片段着色器的运行
```

```ad-note
对于每一个片元，可以在片段着色器中通过内建立值 `gl_FragCoord` 获取每个片元的坐标。该值的 `x, y` 表示片元在屏幕空间中的位置， `z` 即表示这个片元的深度值。
```

深度测试默认是关闭的，开启深度测试需要用到 `GL_DEPTH_TEST` 选项
```cpp
glEnable(GL_DEPTH_TEST);
```

如果开启了深度测试，通常来说，每一帧需要将上一帧的深度缓冲清除掉
```cpp
glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
```

通常来说，在片元通过了深度检测后，会更新深度缓冲中的数据。如果只希望检测要写入的片段是否该丢弃，而不想在通过测试后，改写深度缓冲，我们可以将深度掩码设为 False
```cpp
glDepthMask(GL_FALSE);
```

# 深度检测函数

通常而言，深度检测的比较方法是判断需要写入的片段的深度之是否 ` 小于(GL_LESS)` 当前已经写入片段的深度值。但也可以通过 `glDepthFunc` 设置运算比较符：
```cpp
glDepthFunc(GL_LESS);
```

还接受以下的参数：

| Function    | Description                            |
| ----------- | -------------------------------------- |
| GL_ALWAYS   | 永远通过深度测试                       |
| GL_NEVER    | 永远不通过深度测试                     |
| GL_LESS     | 在待写入深度值小于缓冲深度值时通过     |
| GL_EQUAL    | 在待写入深度值等于缓冲深度值时通过     |
| GL_LEQUAL   | 在待写入深度值小于等于缓冲深度值时通过 |
| GL_GREATER  | 在待写入深度值大于缓冲深度值时通过     |
| GL_NOTEQUAL | 在待写入深度值大于缓冲深度值时通过     |
| GL_GEQUAL   | 在待写入深度值大于等于缓冲深度值时通过 |
