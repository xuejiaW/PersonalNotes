---
cssclass: [table-border]
---

对于一个表面而言，其细节程度与建模的精度相关，如一面墙，可以使用一个简单的平面表示，也可以通过非常精细的建模表示墙上的砖块突起等。

但是精细的模型往往需要消耗大量的资源，因此还有一种方法就是用 `法线贴图（Normal Mapping / Bump Mapping）` 来为模型增加细节。因为对于光照计算而言，一个表面是通过它的法线来表示的（漫反射，镜面反射等都是个光纤与法线的计算）。如下图中，红色的线为真实的表面，黑色的箭头表示法线，绿色的虚线则表示光照计算时，假定的表面的方向：
![](assets/LearnOpenGL-Ch%2029%20Normal%20Mapping/Untitled.png)

# Normal Mapping

因为法线的每一个分量的取值都必定在 $[-1,1]$ 之间，而对于贴图而言，存储的值范围再 $[0,1]$ 之间。因此将法线存储到贴图中，需要经过以下的运算：

```glsl
vec3 rgb_normal = normal * 0.5 + 0.5; // transforms from [-1,1] to [0,1]
```

对于如下左所示的墙面漫反射贴图，就需要用到下右所示的法线贴图来表达：
|                                                                         |                                                                     |
| ----------------------------------------------------------------------- | ------------------------------------------------------------------- |
| ![](assets/LearnOpenGL-Ch%2029%20Normal%20Mapping/Untitled%201%201.png) | ![](assets/LearnOpenGL-Ch%2029%20Normal%20Mapping/Untitled%202.png) |

可以发现法线贴图整体是蓝色，因为对于面朝屏幕的平面而言，其法线是指向屏幕的，即为 $(0,0,1)$ 方向，即在 RGB 空间中表现为蓝色。

```ad-warning
仔细观察上两图会发现，发现贴图的绿色通道分量是反的。如绿色表示的是向上，即 $(0,1,0)$，因此对于砖块而言，它顶部表面的法线是向上的，所以顶部表面的法线贴图应当是偏绿色，而在上右图中，确是砖块底部表面部分的法线贴图是绿的。

这是因为大部分的导出法线贴图的软件都是运行在 Windows 上，即使用的是 DX 的图形接口，而在 DX 中，绿色表示的是向下，即 $(0,-1,0)$。因此为了让 DX 上导出的图在 OpenGL 环境下能正常的显示，需要对绿色通道的颜色取反。

注意，这与在 [Textures](LearnOpenGL-Ch%2004%20Textures.md) 中提到的 DX 和 OpenGL 纹理关于原点的定义不同并非一个问题。
```


使用法线贴图计算光照的着色器与在 [Lighting Maps](LearnOpenGL-Ch%2013%20Lighting%20Maps.md) 中使用的着色器并无太大区别，只不过之前每个片元法线的值，是在顶点着色器中根据顶点的法线计算，然后再插值得到。而现在片元的法线值是通过法线贴图求得，需要注意 RGB 通道的范围是 $[0,1]$ 而法线每个分量的范围是 $[-1,1]$ ，因此还需要进行转换。因此片段着色器中需要进行的改变如下所示：